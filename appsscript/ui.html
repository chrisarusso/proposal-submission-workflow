<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Proposal Submission Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #1a73e8;
      font-size: 24px;
    }
    
    .btn {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn:hover {
      background: #1557b0;
    }
    
    .btn-secondary {
      background: #5f6368;
    }
    
    .btn-secondary:hover {
      background: #3c4043;
    }
    
    .btn-success {
      background: #34a853;
    }
    
    .btn-success:hover {
      background: #2d8e47;
    }
    
    .btn-danger {
      background: #ea4335;
    }
    
    .btn-danger:hover {
      background: #c5221f;
    }
    
    .filters {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .filters select, .filters input {
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #f8f9fa;
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #5f6368;
      border-bottom: 2px solid #dadce0;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #e8eaed;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-draft { background: #e8f0fe; color: #1967d2; }
    .status-in-progress { background: #fef7e0; color: #f9ab00; }
    .status-in-review { background: #e8f5e9; color: #137333; }
    .status-ready { background: #e6f4ea; color: #0d652d; }
    .status-submitted { background: #e8f0fe; color: #1967d2; }
    .status-closed { background: #f1f3f4; color: #5f6368; }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e8eaed;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #34a853;
      transition: width 0.3s;
    }
    
    .actions {
      display: flex;
      gap: 8px;
    }
    
    .actions button {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #5f6368;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #5f6368;
    }
    
    .empty-state h2 {
      margin-bottom: 10px;
      color: #3c4043;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #3c4043;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .status-area {
      margin-top: 16px;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #dadce0;
      background: #f8f9fa;
      color: #3c4043;
    }
    .status-area.info { border-color: #c6dafc; background: #e8f0fe; }
    .status-area.warn { border-color: #f9cc9d; background: #fef7e0; }
    .status-area.error { border-color: #f6c7c7; background: #fce8e6; }

    .suggestions {
      position: relative;
    }
    .suggestions-list {
      position: absolute;
      z-index: 10;
      background: white;
      border: 1px solid #dadce0;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 4px;
      max-height: 180px;
      overflow-y: auto;
      width: 100%;
    }
    .suggestion-item {
      padding: 8px 10px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #f1f3f4;
    }
    .input-error {
      border-color: #ea4335 !important;
    }
    .error-message {
      color: #d93025;
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Proposal Submission Dashboard</h1>
    <div>
      <button class="btn btn-secondary" onclick="refreshDashboard()">Refresh</button>
      <button class="btn" onclick="showCreateProposalModal()">Create New Proposal</button>
    </div>
  </div>
  
  <div class="filters">
    <label>Search:</label>
    <input type="text" id="searchInput" placeholder="Search proposals..." onkeyup="filterProposals()">
  </div>
  
  <div class="table-container">
    <div id="loading" class="loading">Loading proposals...</div>
    <div id="emptyState" class="empty-state" style="display: none;">
      <h2>No proposals found</h2>
      <p>Create your first proposal to get started.</p>
    </div>
    <table id="proposalsTable" style="display: none;">
      <thead>
        <tr>
          <th>Proposal Name</th>
          <th>Stage</th>
          <th id="dueDateHeader" style="cursor:pointer;" onclick="toggleDueDateSort()">Due Date <span id="dueDateSortIndicator">▲</span></th>
          <th>Creator</th>
          <th>Assignee</th>
          <th>Last Updated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="proposalsBody">
      </tbody>
    </table>
  </div>
  <div id="checkStatusArea" class="status-area" style="display:none;"></div>
  
  <!-- Create Proposal Modal -->
  <div id="createModal" class="modal">
    <div class="modal-content">
      <h2>Create New Proposal</h2>
      <form id="createForm">
        <div class="form-group">
          <label>Proposal Document (Doc/Slide) *</label>
          <input type="text" id="proposalDocUrl" list="docSuggestions" placeholder="Start typing document title..." oninput="handleDocSearchInput(this.value)" required>
          <datalist id="docSuggestions"></datalist>
        </div>
        <div class="form-group">
          <label>Assignee (email) *</label>
          <div class="suggestions">
            <input type="text" id="proposalAssignees" list="teamEmailsList" placeholder="owner@savaslabs.com" required>
            <div id="assigneeSuggestions" class="suggestions-list" style="display:none;"></div>
          </div>
          <datalist id="teamEmailsList"></datalist>
          <div id="assigneeError" class="error-message" style="display:none;"></div>
        </div>
        <div class="form-group">
          <label>Due Date *</label>
          <input type="date" id="proposalDeadline" required>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn">Create Proposal</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    console.log('UI script loaded');
    var allProposals = [];
    var filteredProposals = [];
    var currentUserEmail = '';
    var dueDateSortDirection = 'asc'; // default ascending
    var teamEmails = [];
    var existingProposalNames = [];
    var docSearchTimer = null;
    var docSearchResults = [];
    var assigneeInputEl = null;
    var adminEmail = 'chris@savaslabs.com';
    var statusOrder = [];
    
    // Wait for page to be fully loaded
    window.addEventListener('load', function() {
      console.log('Page loaded, calling getAllProposals');
      fetchCurrentUserAndLoad();
    });

    function fetchCurrentUserAndLoad() {
      google.script.run
        .withSuccessHandler(function(email) {
          currentUserEmail = (email || '').toLowerCase();
          loadStatusOptions();
        })
        .withFailureHandler(function(err) {
          console.error('Failed to get current user email', err);
          loadStatusOptions(); // still try to load proposals
        })
        .getCurrentUserEmail();
    }

    function loadStatusOptions() {
      google.script.run
        .withSuccessHandler(function(opts) {
          if (Array.isArray(opts) && opts.length > 0) {
            statusOrder = opts;
          } else {
            statusOrder = ['Draft', 'In Progress', 'In Review', 'Ready for Submission', 'Submitted', 'Closed'];
          }
          loadTeamEmailsAndProposals();
        })
        .withFailureHandler(function(err) {
          console.error('Failed to load status options', err);
          statusOrder = ['Draft', 'In Progress', 'In Review', 'Ready for Submission', 'Submitted', 'Closed'];
          loadTeamEmailsAndProposals();
        })
        .getStatusOptions();
    }

    function loadTeamEmailsAndProposals() {
      google.script.run
        .withSuccessHandler(function(emails) {
          console.log('[team emails] loaded', emails);
          teamEmails = Array.isArray(emails) ? emails : [];
          populateTeamEmailSuggestions();
          loadExistingProposalNames();
        })
        .withFailureHandler(function(err) {
          console.error('Failed to load team emails', err);
          loadExistingProposalNames();
        })
        .getTeamEmails();
    }

    function loadExistingProposalNames() {
      google.script.run
        .withSuccessHandler(function(names) {
          existingProposalNames = Array.isArray(names) ? names : [];
          loadProposals();
        })
        .withFailureHandler(function(err) {
          console.error('Failed to load proposal names', err);
          loadProposals();
        })
        .getExistingProposalNames();
    }

    function populateTeamEmailSuggestions() {
      var list = document.getElementById('teamEmailsList');
      if (!list) return;
      list.innerHTML = '';
      teamEmails.forEach(function(email) {
        var opt = document.createElement('option');
        opt.value = email;
        list.appendChild(opt);
      });
      if (!assigneeInputEl) {
        assigneeInputEl = document.getElementById('proposalAssignees');
        if (assigneeInputEl) {
          assigneeInputEl.addEventListener('input', function(e) {
            updateAssigneeSuggestions(e.target.value);
            validateAssigneesLive(e.target.value);
          });
          assigneeInputEl.addEventListener('blur', function(e) {
            setTimeout(hideAssigneeSuggestions, 150); // allow click
          });
        }
      }
    }

    function loadProposals() {
      console.log('loadProposals called');
      try {
        google.script.run
          .withSuccessHandler(handleProposalsSuccess)
          .withFailureHandler(function(error) {
            console.error('Failure handler called:', error);
            showError(error);
          })
          .getAllProposals();
      } catch (e) {
        console.error('Error calling google.script.run:', e);
        showError(e);
      }
    }
    
    // Also try loading immediately (fallback)
    console.log('Attempting immediate load');
    try {
      google.script.run
        .withSuccessHandler(handleProposalsSuccess)
        .withFailureHandler(function(error) {
          console.error('Immediate load error:', error);
          showError(error);
        })
        .getAllProposals();
    } catch (e) {
      console.error('Immediate load exception:', e);
    }
    
    function handleProposalsSuccess(proposals) {
      console.log('Success handler called with:', proposals);
      allProposals = proposals || [];
      filteredProposals = applyDueDateSort(allProposals.slice());
      displayProposals(filteredProposals);
    }
    
    function displayProposals(proposals) {
      console.log('=== displayProposals START ===');
      console.log('Received proposals:', proposals);
      console.log('Type:', typeof proposals);
      console.log('Is array:', Array.isArray(proposals));
      console.log('Length:', proposals ? proposals.length : 'null/undefined');
      
      try {
        var loadingEl = document.getElementById('loading');
        var emptyStateEl = document.getElementById('emptyState');
        var tableEl = document.getElementById('proposalsTable');
        var tbodyEl = document.getElementById('proposalsBody');
        
        console.log('Elements found:', {
          loading: !!loadingEl,
          emptyState: !!emptyStateEl,
          table: !!tableEl,
          tbody: !!tbodyEl
        });
        
        if (!loadingEl || !emptyStateEl || !tableEl || !tbodyEl) {
          console.error('Missing required elements!');
          alert('Error: Missing HTML elements. Check console.');
          return;
        }
        
        loadingEl.style.display = 'none';
        
        if (!proposals || proposals.length === 0) {
          console.log('No proposals to display - showing empty state');
          emptyStateEl.style.display = 'block';
          tableEl.style.display = 'none';
          return;
        }
        
        console.log('Displaying', proposals.length, 'proposals');
        emptyStateEl.style.display = 'none';
        tableEl.style.display = 'table';
        
        tbodyEl.innerHTML = '';
        
        filteredProposals.forEach(function(proposal, index) {
          try {
            console.log('Adding proposal', index, ':', proposal.name, proposal.id);
            var row = document.createElement('tr');
          var stageVal = proposal.stage || proposal.status || 'draft';
          var statusClass = 'status-' + stageVal.toLowerCase().replace(/\s+/g, '-');
          var canDelete = currentUserEmail && proposal.owner && proposal.owner.toLowerCase() === currentUserEmail;
          var isAdmin = currentUserEmail && currentUserEmail === adminEmail;
          var isAssignee = currentUserEmail && proposal.assignee && proposal.assignee.toLowerCase() === currentUserEmail;
          var selectId = 'statusSelect-' + (proposal.id || index);
          var nextSt = getNextStatus(proposal.status);
          var stageCellHtml = '<span class="status-badge ' + statusClass + '">' + escapeHtml(stageVal || 'Draft') + '</span>';
          if (isAdmin || isAssignee) {
            var opts = '';
            opts += '<option value="' + (proposal.status || '') + '" selected>' + (proposal.status || 'Current') + '</option>';
            if (nextSt) {
              opts += '<option value="' + nextSt + '">' + nextSt + '</option>';
            }
            stageCellHtml = '<select id="' + selectId + '" class="btn" style="padding:6px 8px;" ' + (nextSt ? '' : 'disabled') + ' onchange="advanceProposal(\'' + (proposal.id || '') + '\', this.value)">' + opts + '</select>';
          }
          var actionsHtml = canDelete ? '<button class="btn btn-danger" onclick="deleteProposal(\'' + (proposal.id || '') + '\')">Delete</button>' : '<span style="color:#5f6368;">&nbsp;</span>';
            row.innerHTML = 
              '<td><strong>' + escapeHtml(proposal.name || 'Untitled') + '</strong></td>' +
            '<td>' + stageCellHtml + '</td>' +
              '<td>' + formatDateOnly(proposal.deadline) + '</td>' +
              '<td>' + escapeHtml(proposal.creator || proposal.owner || 'Unknown') + '</td>' +
              '<td>' + escapeHtml(proposal.assignee || '') + '</td>' +
              '<td>' + formatDate(proposal.updatedAt) + '</td>' +
            '<td><div class="actions">' + actionsHtml + '</div></td>';
            tbodyEl.appendChild(row);
            console.log('Row added successfully');
          } catch (e) {
            console.error('Error adding proposal row', index, ':', e);
          }
        });
        
        console.log('=== displayProposals END: Successfully displayed', proposals.length, 'proposals ===');
      } catch (e) {
        console.error('=== displayProposals ERROR ===');
        console.error('Error:', e);
        console.error('Stack:', e.stack);
        alert('Error displaying proposals: ' + e.message);
      }
    }
    
    function filterProposals() {
      var searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      filteredProposals = applyDueDateSort(allProposals.filter(function(proposal) {
        var matchSearch = !searchTerm || 
          proposal.name.toLowerCase().indexOf(searchTerm) !== -1 ||
          (proposal.owner || '').toLowerCase().indexOf(searchTerm) !== -1 ||
          (proposal.creator || '').toLowerCase().indexOf(searchTerm) !== -1 ||
          (proposal.assignee || '').toLowerCase().indexOf(searchTerm) !== -1;
        
        return matchSearch;
      }));
      
      displayProposals(filteredProposals);
    }
    
    function refreshDashboard() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('proposalsTable').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(handleProposalsSuccess)
        .withFailureHandler(showError)
        .getAllProposals();
    }
    
    function showCreateProposalModal() {
      document.getElementById('createModal').classList.add('active');
      document.getElementById('createForm').reset();
      // Default due date: one week from today
      var dueInput = document.getElementById('proposalDeadline');
      if (dueInput) {
        var dt = new Date();
        dt.setDate(dt.getDate() + 7);
        var yyyy = dt.getFullYear();
        var mm = ('0' + (dt.getMonth() + 1)).slice(-2);
        var dd = ('0' + dt.getDate()).slice(-2);
        dueInput.value = yyyy + '-' + mm + '-' + dd;
      }
      clearAssigneeValidation();
    }
    
    function closeCreateModal() {
      document.getElementById('createModal').classList.remove('active');
    }
    
    document.getElementById('createForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      var proposalData = {
        name: null,
        type: 'RFP',
        deadline: document.getElementById('proposalDeadline').value || null,
        documentUrl: null,
        assignees: (document.getElementById('proposalAssignees').value || '')
      };

      // Resolve document by selected title (matches most recent search results)
      var docTitleInput = document.getElementById('proposalDocUrl').value || '';
      if (docTitleInput.trim() !== '') {
        var matched = docSearchResults.find(function(f) {
          return f && f.name && f.name.toLowerCase() === docTitleInput.trim().toLowerCase();
        });
        if (matched) {
          proposalData.documentUrl = matched.url;
          proposalData.documentId = matched.id;
          proposalData.name = matched.name;
        } else {
          // As a fallback, if user pasted a URL, extract ID
          var matchUrl = docTitleInput.match(/\/d\/([a-zA-Z0-9-_]+)/);
          if (matchUrl) {
            proposalData.documentUrl = docTitleInput;
            proposalData.documentId = matchUrl[1];
            proposalData.name = docTitleInput; // backend will derive from doc ID
          } else {
            alert('Please pick a document from suggestions or paste a valid Doc/Slide URL.');
            return;
          }
        }
      } else {
        alert('Please pick a document for this proposal.');
        return;
      }

      // Require at least one assignee
      if (!proposalData.assignees || proposalData.assignees.trim() === '') {
        alert('Please enter an assignee (email).');
        return;
      }

      var emailCheck = validateEmails(proposalData.assignees);
      if (!emailCheck.valid || emailCheck.parts.length !== 1) {
        alert('Please enter exactly one valid email address.');
        return;
      }

      if (!proposalData.deadline) {
        alert('Please select a due date.');
        return;
      }
      
      // Extract document ID from URL if provided
      if (proposalData.documentUrl) {
        var match = proposalData.documentUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (match) {
          proposalData.documentId = match[1];
        }
      }
      
      google.script.run
        .withSuccessHandler(function(proposal) {
          closeCreateModal();
          refreshDashboard();
        })
        .withFailureHandler(showError)
        .createProposal(proposalData);
    });
    
    function viewProposal(proposalId) {
      try {
        google.script.run
          .withSuccessHandler(function(baseUrl) {
            try {
              var clean = normalizeWebAppUrl(baseUrl);
              var sep = clean.indexOf('?') === -1 ? '?' : '&';
              var url = clean + sep + 'proposalId=' + encodeURIComponent(proposalId);
              console.log('Opening proposal detail:', url);
              window.open(url, '_blank');
            } catch (inner) {
              console.error('Error building URL from baseUrl:', baseUrl, inner);
              var fb = window.location.origin + window.location.pathname + '?proposalId=' + encodeURIComponent(proposalId);
              window.open(fb, '_blank');
            }
          })
          .withFailureHandler(function(err) {
            console.error('Failed to get web app URL, falling back to current origin/path:', err);
            var fallback = window.location.origin + window.location.pathname + '?proposalId=' + encodeURIComponent(proposalId);
            window.open(fallback, '_blank');
          })
          .getWebAppUrl();
      } catch (e) {
        console.error('Error building detail URL:', e);
        var fallback = window.location.origin + window.location.pathname + '?proposalId=' + encodeURIComponent(proposalId);
        window.open(fallback, '_blank');
      }
    }
    
  function editProposal(proposalId) {
      viewProposal(proposalId);
    }

    function deleteProposal(proposalId) {
      if (!proposalId) {
        alert('No proposal ID');
        return;
      }
      if (!confirm('Delete this proposal? This action cannot be undone.')) {
        return;
      }
      google.script.run
        .withSuccessHandler(function(res) {
          refreshDashboard();
        })
        .withFailureHandler(showError)
        .deleteProposal(proposalId);
    }
    
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      var date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

  function formatDateOnly(dateString) {
    if (!dateString) return 'N/A';
    if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
      return dateString;
    }
    var d = parseDateValue(dateString);
    return d ? d.toLocaleDateString() : 'N/A';
  }

  function parseDateValue(val) {
    if (!val) return null;
    var d = new Date(val);
    return isNaN(d) ? null : d;
  }

  function applyDueDateSort(list) {
    var sorted = (list || []).slice().sort(function(a, b) {
      var da = parseDateValue(a && a.deadline);
      var db = parseDateValue(b && b.deadline);
      if (!da && !db) return 0;
      if (!da) return 1;      // no deadline goes last
      if (!db) return -1;
      return da - db;         // earliest first
    });
    if (dueDateSortDirection === 'desc') {
      sorted.reverse();
    }
    updateDueDateIndicator();
    return sorted;
  }

  function toggleDueDateSort() {
    dueDateSortDirection = dueDateSortDirection === 'asc' ? 'desc' : 'asc';
    updateDueDateIndicator();
    filteredProposals = applyDueDateSort(filteredProposals);
    displayProposals(filteredProposals);
  }

  function updateDueDateIndicator() {
    var indicator = document.getElementById('dueDateSortIndicator');
    if (indicator) {
      indicator.textContent = dueDateSortDirection === 'asc' ? '▲' : '▼';
    }
  }

  function handleDocSearchInput(val) {
    if (docSearchTimer) {
      clearTimeout(docSearchTimer);
    }
    docSearchTimer = setTimeout(function() {
      var q = (val || '').trim();
      if (q.length < 3) return;
      google.script.run
        .withSuccessHandler(function(files) {
          docSearchResults = files || [];
          var list = document.getElementById('docSuggestions');
          if (!list) return;
          list.innerHTML = '';
          docSearchResults.forEach(function(f) {
            var opt = document.createElement('option');
            opt.value = f.name; // show title as the selectable value
            opt.label = f.name;
            list.appendChild(opt);
          });
        })
        .withFailureHandler(function(err) {
          console.error('Doc search failed', err);
        })
        .searchDocsByName(q);
    }, 300);
  }

  function validateEmails(raw) {
    if (!raw) return { valid: false, invalid: [], parts: [] };
    var parts = raw.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
    if (parts.length === 0) return { valid: false, invalid: [], parts: [] };
    // enforce single email
    if (parts.length > 1) return { valid: false, invalid: parts.slice(1), parts: parts };
    var re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
    var invalid = parts.filter(function(email) { return !re.test(email); });
    return { valid: invalid.length === 0, invalid: invalid, parts: parts };
  }

  function updateAssigneeSuggestions(raw) {
    var listEl = document.getElementById('assigneeSuggestions');
    if (!listEl) return;
    var frag = (raw || '').trim();
    if (!frag || frag.length < 1) {
      listEl.style.display = 'none';
      listEl.innerHTML = '';
      return;
    }
    var lower = frag.toLowerCase();
    var matches = teamEmails
      .filter(function(e) { return e && e.toLowerCase().indexOf(lower) !== -1; })
      .slice(0, 8);
    if (matches.length === 0) {
      listEl.style.display = 'none';
      listEl.innerHTML = '';
      return;
    }
    listEl.innerHTML = '';
    matches.forEach(function(m) {
      var div = document.createElement('div');
      div.className = 'suggestion-item';
      div.textContent = m;
      div.onclick = function() {
        insertAssignee(m);
      };
      listEl.appendChild(div);
    });
    listEl.style.display = 'block';
  }

  function insertAssignee(email) {
    var input = document.getElementById('proposalAssignees');
    if (!input) return;
    input.value = email;
    updateAssigneeSuggestions(input.value);
    validateAssigneesLive(input.value);
  }

  function getLastEmailFragment(raw) {
    if (!raw) return '';
    var parts = raw.split(',');
    return (parts[parts.length - 1] || '').trim();
  }

  function hideAssigneeSuggestions() {
    var listEl = document.getElementById('assigneeSuggestions');
    if (listEl) listEl.style.display = 'none';
  }

  function validateAssigneesLive(raw) {
    var res = validateEmails(raw);
    var input = document.getElementById('proposalAssignees');
    var errEl = document.getElementById('assigneeError');
    if (!input || !errEl) return;
    if (!raw) {
      errEl.style.display = 'none';
      input.classList.remove('input-error');
      return;
    }
    if (res.valid && res.parts.length === 1) {
      errEl.style.display = 'none';
      input.classList.remove('input-error');
    } else {
      var msg = res.parts.length > 1 ? 'Only one assignee allowed.' :
        ('Invalid email: ' + (res.invalid.join(', ') || raw));
      errEl.textContent = msg;
      errEl.style.display = 'block';
      input.classList.add('input-error');
    }
  }

  function getNextStatus(currentStatus) {
    var idx = statusOrder.indexOf(currentStatus);
    if (idx === -1 || idx === statusOrder.length - 1) {
      return statusOrder[statusOrder.length - 1];
    }
    return statusOrder[idx + 1];
  }

  function advanceProposal(proposalId, targetStatus) {
    if (!targetStatus) return;
    setCheckStatus('Advancing and running checks...', 'info');
    setLoading('Advancing...');
    google.script.run
      .withSuccessHandler(function(res) {
        clearLoading();
        if (res && res.warnings && res.warnings.length) {
          setCheckStatus(res.warnings.join('\n'), 'warn');
        } else {
          setCheckStatus('Stage updated. No warnings detected.', 'info');
        }
        refreshDashboard();
      })
      .withFailureHandler(function(err) {
        clearLoading();
        setCheckStatus('Stage update failed: ' + (err && (err.message || err.toString()) ? (err.message || err.toString()) : 'unknown error'), 'error');
        showError(err);
      })
      .updateProposalStatus(proposalId, targetStatus);
  }

  function updateStatus(proposalId, selectId) {
    var sel = document.getElementById(selectId);
    if (!sel) return;
    var target = sel.value;
    setCheckStatus('Updating stage and running checks...', 'info');
    setLoading('Updating status...');
    google.script.run
      .withSuccessHandler(function(res) {
        clearLoading();
        if (res && res.warnings && res.warnings.length) {
          setCheckStatus(res.warnings.join('\n'), 'warn');
        } else {
          setCheckStatus('Stage updated. No warnings detected.', 'info');
        }
        refreshDashboard();
      })
      .withFailureHandler(function(err) {
        clearLoading();
        setCheckStatus('Stage update failed: ' + (err && (err.message || err.toString()) ? (err.message || err.toString()) : 'unknown error'), 'error');
        showError(err);
      })
      .updateProposalStatus(proposalId, target);
  }

  function setCheckStatus(message, level) {
    var area = document.getElementById('checkStatusArea');
    if (!area) return;
    area.className = 'status-area ' + (level || 'info');
    area.textContent = message;
    area.style.display = message ? 'block' : 'none';
  }

  // Fallback loading helpers (no-op for now, just toggles loading text element)
  function setLoading(msg) {
    var loadingEl = document.getElementById('loading');
    if (loadingEl) {
      loadingEl.textContent = msg || 'Loading...';
      loadingEl.style.display = 'block';
    }
  }

  function clearLoading() {
    var loadingEl = document.getElementById('loading');
    if (loadingEl) {
      loadingEl.style.display = 'none';
    }
  }

  function normalizeWebAppUrl(baseUrl) {
    // Start from provided base, else current page URL
    var href = baseUrl && baseUrl.trim() ? baseUrl : window.location.href;
    var clean = href.split('#')[0].split('?')[0];
    // Normalize known patterns to /exec
    clean = clean.replace(/\/userCodeAppPanel.*/i, '/exec');
    clean = clean.replace(/\/dev$/i, '/exec');
    // If we still don't have /exec, append it to origin/path
    if (clean.indexOf('/exec') === -1) {
      var originPath = window.location.origin + window.location.pathname;
      if (originPath.indexOf('/exec') === -1) {
        // If pathname already ends with /dev or /exec-like, swap to /exec
        originPath = originPath.replace(/\/dev$/i, '/exec');
        if (originPath.indexOf('/exec') === -1) {
          // last resort: append /exec
          if (originPath.endsWith('/')) {
            originPath = originPath + 'exec';
          } else {
            originPath = originPath + '/exec';
          }
        }
      }
      clean = originPath;
    }
    return clean;
  }

  function clearAssigneeValidation() {
    var input = document.getElementById('proposalAssignees');
    var errEl = document.getElementById('assigneeError');
    var listEl = document.getElementById('assigneeSuggestions');
    if (input) input.classList.remove('input-error');
    if (errEl) errEl.style.display = 'none';
    if (listEl) listEl.style.display = 'none';
  }
    
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function showError(error) {
      console.error('Error in UI:', error);
      console.error('Error details:', JSON.stringify(error));
      alert('Error: ' + (error.message || error.toString()));
      document.getElementById('loading').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('emptyState').innerHTML = '<h2>Error Loading Proposals</h2><p>' + (error.message || error.toString()) + '</p><p>Check browser console (F12) for details.</p>';
    }
  </script>
</body>
</html>

