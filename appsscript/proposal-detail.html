<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Proposal Details</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      color: #1a73e8;
      font-size: 24px;
    }
    
    .btn {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-left: 10px;
    }
    
    .btn:hover {
      background: #1557b0;
    }
    
    .btn-secondary {
      background: #5f6368;
    }
    
    .btn-success {
      background: #34a853;
    }
    
    .btn-danger {
      background: #ea4335;
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #3c4043;
      border-bottom: 2px solid #e8eaed;
      padding-bottom: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #5f6368;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .checklist {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .checklist-item {
      padding: 10px;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .checklist-item:last-child {
      border-bottom: none;
    }
    
    .checklist-item input[type="checkbox"] {
      margin-top: 3px;
      cursor: pointer;
    }
    
    .checklist-item label {
      flex: 1;
      cursor: pointer;
    }
    
    .checklist-item.completed label {
      text-decoration: line-through;
      color: #5f6368;
    }
    
    .check-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: 8px;
      background: #e8f0fe;
      color: #1967d2;
    }
    
    .required-strings {
      margin-top: 15px;
    }
    
    .string-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .string-item strong {
      color: #1a73e8;
    }
    
    .add-string-form {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .add-string-form input {
      flex: 1;
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
    }
    
    .check-results {
      margin-top: 15px;
    }
    
    .check-result {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .check-result.success {
      border-left: 4px solid #34a853;
    }
    
    .check-result.error {
      border-left: 4px solid #ea4335;
    }
    
    .check-result h3 {
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .check-result ul {
      margin-left: 20px;
      margin-top: 8px;
    }
    
    .audit-log {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .audit-entry {
      padding: 10px;
      border-bottom: 1px solid #e8eaed;
      font-size: 13px;
    }
    
    .audit-entry:last-child {
      border-bottom: none;
    }
    
    .audit-entry .timestamp {
      color: #5f6368;
      font-size: 12px;
    }
    
    .audit-entry .user {
      font-weight: 500;
      color: #1a73e8;
    }
    
    .audit-entry .action {
      color: #34a853;
      font-weight: 500;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    .progress-section {
      margin-top: 15px;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e8eaed;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: #34a853;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="proposalTitle">Proposal Details</h1>
    <div>
      <button class="btn btn-secondary" onclick="google.script.host.close()">Close</button>
      <button class="btn btn-success" onclick="runValidation()">Validate Before Submission</button>
      <button class="btn" onclick="runChecks()">Run Automated Checks</button>
      <button class="btn" onclick="saveProposal()">Save Changes</button>
    </div>
  </div>
  
  <div class="content-grid">
    <div class="card">
      <h2>Proposal Information</h2>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="proposalName" onchange="markDirty()">
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="proposalType" onchange="markDirty()">
          <option value="RFP">RFP</option>
          <option value="Client">Client</option>
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="proposalStatus" onchange="markDirty()">
          <option value="Draft">Draft</option>
          <option value="In Progress">In Progress</option>
          <option value="In Review">In Review</option>
          <option value="Ready for Submission">Ready for Submission</option>
          <option value="Submitted">Submitted</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
      <div class="form-group">
        <label>Deadline</label>
        <input type="date" id="proposalDeadline" onchange="markDirty()">
      </div>
      <div class="form-group">
        <label>Owner</label>
        <input type="text" id="proposalOwner" readonly>
      </div>
      <div class="progress-section">
        <label>Progress</label>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h2>Required Strings</h2>
      <div id="requiredStringsList" class="required-strings">
        <!-- Required strings will be populated here -->
      </div>
      <div class="add-string-form">
        <input type="text" id="newString" placeholder="Enter required string">
        <input type="text" id="newStringDesc" placeholder="Description (optional)">
        <button class="btn" onclick="addRequiredString()">Add</button>
      </div>
    </div>
    
    <div class="card full-width">
      <h2>Checklist</h2>
      <div id="checklistContainer" class="checklist">
        <!-- Checklist items will be populated here -->
      </div>
    </div>
    
    <div class="card full-width">
      <h2>Automated Check Results</h2>
      <div id="checkResults" class="check-results">
        <p style="color: #5f6368;">No checks run yet. Click "Run Automated Checks" to analyze the proposal.</p>
      </div>
    </div>
    
    <div class="card full-width">
      <h2>Audit Log</h2>
      <div id="auditLog" class="audit-log">
        <!-- Audit log entries will be populated here -->
      </div>
    </div>
  </div>
  
  <script>
    var proposalId = null;
    var proposal = null;
    var isDirty = false;
    
    // Get proposal ID from URL parameters
    window.onload = function() {
      var params = new URLSearchParams(window.location.search);
      proposalId = params.get('proposalId');
      console.log('Detail page loaded for proposalId:', proposalId);
      if (!proposalId) {
        alert('No proposalId provided in URL');
        return;
      }
      loadProposal();
    };
    
    function loadProposal() {
      google.script.run
        .withSuccessHandler(displayProposal)
        .withFailureHandler(showError)
        .getProposalData(proposalId);
    }
    
    function displayProposal(data) {
      proposal = data;
      proposalId = data.id;
      
      document.getElementById('proposalTitle').textContent = data.name;
      document.getElementById('proposalName').value = data.name;
      document.getElementById('proposalType').value = data.type;
      document.getElementById('proposalStatus').value = data.status;
      document.getElementById('proposalDeadline').value = data.deadline ? data.deadline.split('T')[0] : '';
      document.getElementById('proposalOwner').value = data.owner;
      
      updateProgress(data.progress);
      displayChecklist(data);
      displayRequiredStrings(data.requiredStrings || []);
      displayCheckResults(data.checkResults || {});
      loadAuditLog();
    }
    
    function displayChecklist(data) {
      var container = document.getElementById('checklistContainer');
      container.innerHTML = '';
      
      var allItems = [];
      if (data.checklist && data.checklist.items) {
        allItems = allItems.concat(data.checklist.items);
      }
      if (data.customChecklistItems) {
        allItems = allItems.concat(data.customChecklistItems);
      }
      
      allItems.forEach(function(item) {
        var div = document.createElement('div');
        div.className = 'checklist-item' + (item.completed ? ' completed' : '');
        div.innerHTML = 
          '<input type="checkbox" ' + (item.completed ? 'checked' : '') + 
          ' onchange="toggleChecklistItem(\'' + item.id + '\', this.checked)">' +
          '<label>' + escapeHtml(item.description) + 
          (item.checkType ? '<span class="check-badge">' + item.checkType + '</span>' : '') +
          '</label>';
        container.appendChild(div);
      });
    }
    
    function displayRequiredStrings(strings) {
      var container = document.getElementById('requiredStringsList');
      container.innerHTML = '';
      
      if (strings.length === 0) {
        container.innerHTML = '<p style="color: #5f6368;">No required strings added yet.</p>';
        return;
      }
      
      strings.forEach(function(str) {
        var div = document.createElement('div');
        div.className = 'string-item';
        div.innerHTML = 
          '<div><strong>' + escapeHtml(str.string) + '</strong>' +
          (str.description ? '<br><small>' + escapeHtml(str.description) + '</small>' : '') +
          '</div>' +
          '<button class="btn btn-danger" onclick="removeRequiredString(\'' + str.id + '\')">Remove</button>';
        container.appendChild(div);
      });
    }
    
    function displayCheckResults(results) {
      var container = document.getElementById('checkResults');
      container.innerHTML = '';
      
      if (Object.keys(results).length === 0) {
        container.innerHTML = '<p style="color: #5f6368;">No checks run yet.</p>';
        return;
      }
      
      Object.keys(results).forEach(function(checkId) {
        var result = results[checkId].result;
        var div = document.createElement('div');
        div.className = 'check-result ' + (result.success ? 'success' : 'error');
        div.innerHTML = 
          '<h3>' + (result.checkType || 'Check') + ' - ' + (result.success ? 'Passed' : 'Failed') + '</h3>' +
          '<p>' + escapeHtml(result.message || '') + '</p>' +
          (result.errors && result.errors.length > 0 ? 
            '<ul>' + result.errors.map(function(e) { return '<li>' + escapeHtml(e.text || e) + '</li>'; }).join('') + '</ul>' : '') +
          (result.missingStrings && result.missingStrings.length > 0 ?
            '<p><strong>Missing strings:</strong> ' + result.missingStrings.join(', ') + '</p>' : '');
        container.appendChild(div);
      });
    }
    
    function loadAuditLog() {
      google.script.run
        .withSuccessHandler(function(logs) {
          var container = document.getElementById('auditLog');
          container.innerHTML = '';
          
          if (logs.length === 0) {
            container.innerHTML = '<p style="color: #5f6368;">No audit log entries yet.</p>';
            return;
          }
          
          logs.forEach(function(log) {
            var div = document.createElement('div');
            div.className = 'audit-entry';
            div.innerHTML = 
              '<span class="timestamp">' + escapeHtml(log.timestamp) + '</span> ' +
              '<span class="user">' + escapeHtml(log.user) + '</span> ' +
              '<span class="action">' + escapeHtml(log.action) + '</span> ' +
              '<span>' + escapeHtml(JSON.stringify(log.details)) + '</span>';
            container.appendChild(div);
          });
        })
        .withFailureHandler(showError)
        .getAuditLog(proposalId, 50);
    }
    
    function toggleChecklistItem(itemId, completed) {
      google.script.run
        .withSuccessHandler(function(updated) {
          proposal = updated;
          updateProgress(updated.progress);
          loadAuditLog();
        })
        .withFailureHandler(showError)
        .updateChecklistItem(proposalId, itemId, completed);
    }
    
    function addRequiredString() {
      var string = document.getElementById('newString').value.trim();
      var description = document.getElementById('newStringDesc').value.trim();
      
      if (!string) {
        alert('Please enter a required string');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(req) {
          proposal.requiredStrings = proposal.requiredStrings || [];
          proposal.requiredStrings.push(req);
          displayRequiredStrings(proposal.requiredStrings);
          document.getElementById('newString').value = '';
          document.getElementById('newStringDesc').value = '';
          loadAuditLog();
        })
        .withFailureHandler(showError)
        .addRequiredString(proposalId, string, description);
    }
    
    function removeRequiredString(stringId) {
      if (!confirm('Remove this required string?')) return;
      
      google.script.run
        .withSuccessHandler(function() {
          proposal.requiredStrings = proposal.requiredStrings.filter(function(s) {
            return s.id !== stringId;
          });
          displayRequiredStrings(proposal.requiredStrings);
          loadAuditLog();
        })
        .withFailureHandler(showError)
        .removeRequiredString(proposalId, stringId);
    }
    
    function runChecks() {
      if (!proposal) return;
      
      google.script.run
        .withSuccessHandler(function(results) {
          alert('Checks completed. ' + results.summary.passed + ' passed, ' + results.summary.failed + ' failed.');
          loadProposal(); // Reload to see results
        })
        .withFailureHandler(showError)
        .runStageBasedChecks(proposalId, proposal.stage);
    }
    
    function runValidation() {
      google.script.run
        .withSuccessHandler(function(results) {
          var message = results.valid ? 
            'Validation passed! Ready for submission.' :
            'Validation failed:\n' + 
            (results.errors.length > 0 ? 'Errors:\n' + results.errors.join('\n') + '\n\n' : '') +
            (results.warnings.length > 0 ? 'Warnings:\n' + results.warnings.join('\n') : '');
          alert(message);
        })
        .withFailureHandler(showError)
        .validateBeforeSubmission(proposalId);
    }
    
    function saveProposal() {
      var updates = {
        name: document.getElementById('proposalName').value,
        type: document.getElementById('proposalType').value,
        status: document.getElementById('proposalStatus').value,
        deadline: document.getElementById('proposalDeadline').value || null
      };
      
      google.script.run
        .withSuccessHandler(function() {
          isDirty = false;
          alert('Proposal saved successfully');
          loadProposal();
        })
        .withFailureHandler(showError)
        .saveProposalData(proposalId, Object.assign({}, proposal, updates));
    }
    
    function updateProgress(progress) {
      document.getElementById('progressFill').style.width = progress + '%';
      document.getElementById('progressFill').textContent = progress + '%';
    }
    
    function markDirty() {
      isDirty = true;
    }
    
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function showError(error) {
      alert('Error: ' + error.message);
    }
  </script>
</body>
</html>

